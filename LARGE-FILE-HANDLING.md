# 大文件处理指南

## 文件大小限制

当前配置支持的文件大小：
- **最大文件上传**: 500MB
- **最大请求体**: 200MB
- **最大解析输出**: 200MB
- **最大操作数量**: 10,000个操作

## 性能优化

### 1. 内存管理
- 自动监控内存使用情况
- 限制操作数量防止内存溢出
- 自动垃圾回收（如果可用）
- 及时清理临时文件

### 2. 解析优化
- 流式处理大文件
- 进度显示和状态监控
- 分批处理避免阻塞
- 错误恢复机制

## 大文件处理建议

### 30MB+ 文件
- 解析时间可能较长（1-5分钟）
- 建议在服务器环境运行
- 确保有足够的内存（建议4GB+）

### 100MB+ 文件
- 考虑分割binlog文件
- 使用专用服务器
- 监控内存使用情况

### 500MB+ 文件
- 建议分割为多个小文件
- 或者增加服务器配置
- 考虑使用流式处理

## 分割binlog文件

如果文件过大，可以使用以下方法分割：

### 方法1: 使用mysqlbinlog
```bash
# 按时间范围分割
mysqlbinlog --start-datetime="2024-01-01 00:00:00" \
           --stop-datetime="2024-01-01 12:00:00" \
           mysql-bin.000001 > part1.sql

mysqlbinlog --start-datetime="2024-01-01 12:00:00" \
           --stop-datetime="2024-01-02 00:00:00" \
           mysql-bin.000001 > part2.sql
```

### 方法2: 按位置分割
```bash
# 按起始和结束位置
mysqlbinlog --start-position=4 \
           --stop-position=1000000 \
           mysql-bin.000001 > part1.sql
```

### 方法3: 使用split命令
```bash
# 按大小分割（每个文件50MB）
split -b 50M mysql-bin.000001 part_

# 按行数分割
split -l 100000 mysql-bin.000001 part_
```

## 错误处理

### 常见错误及解决方案

#### 1. PayloadTooLargeError
```
错误: request entity too large
解决: 文件过大，需要分割或增加服务器配置
```

#### 2. 内存不足
```
错误: JavaScript heap out of memory
解决: 增加Node.js内存限制
```
```bash
# 启动时增加内存限制
node --max-old-space-size=8192 server.js
```

#### 3. 解析超时
```
错误: 解析过程中断或超时
解决: 分割文件或增加超时时间
```

## 服务器配置建议

### 最小配置
- CPU: 2核心
- 内存: 4GB
- 磁盘: 10GB可用空间

### 推荐配置
- CPU: 4核心+
- 内存: 8GB+
- 磁盘: 50GB+ SSD

### 高性能配置
- CPU: 8核心+
- 内存: 16GB+
- 磁盘: 100GB+ NVMe SSD

## 监控和调试

### 内存监控
服务器会自动显示内存使用情况：
```
初始内存使用: { rss: 45.2, heapTotal: 20.1, heapUsed: 15.3 }
解析后内存使用: { rss: 156.7, heapTotal: 89.2, heapUsed: 78.4 }
```

### 性能日志
```
文件大小: 30.25 MB
开始解析binlog...
解析完成，输出大小: 45.67 MB
开始提取操作...
解析进度: 25.0% (5000/20000)
解析进度: 50.0% (10000/20000)
解析完成，共找到 1234 个操作
```

## 故障排除

### 1. 文件上传失败
- 检查文件大小是否超限
- 确认网络连接稳定
- 检查磁盘空间是否充足

### 2. 解析失败
- 确认文件是有效的binlog格式
- 检查mysqlbinlog工具是否安装
- 查看服务器错误日志

### 3. 内存不足
- 重启服务释放内存
- 增加服务器内存
- 分割大文件处理

### 4. 性能问题
- 使用SSD存储
- 增加CPU核心数
- 优化系统配置

## 最佳实践

1. **预处理**: 在上传前检查文件大小和格式
2. **分批处理**: 将大文件分割为多个小文件
3. **监控资源**: 实时监控内存和CPU使用情况
4. **备份数据**: 处理前备份原始binlog文件
5. **测试环境**: 先在测试环境验证大文件处理
6. **定期清理**: 清理临时文件和日志
7. **性能调优**: 根据实际情况调整配置参数